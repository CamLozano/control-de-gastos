<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos (Conexi贸n Personal)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Link to Manifest File -->
<link rel="manifest" href="manifest.json">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Theme Color for Safari -->
<meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
        .container { max-width: 90%; margin: 2rem auto; padding: 1.5rem; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; border: none; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-delete { background: none; border: none; color: #ef4444; cursor: pointer; }
        .summary-card { padding: 1.25rem; border-radius: 0.5rem; text-align: center; font-weight: 600; }
        .summary-card.income { background-color: #d1fae5; color: #065f46; }
        .summary-card.expense { background-color: #fee2e2; color: #991b1b; }
        .summary-card.balance { background-color: #e0f2fe; color: #1e40af; }
        .running-balance-positive { color: #10b981; }
        .running-balance-negative { color: #dc2626; }
        .tab-button { background-color: transparent; border: 2px solid transparent; color: #6b7280; padding: 0.5rem 1rem; font-weight: 600; border-radius: 0.5rem; }
        .tab-button.active { color: #4f46e5; border-color: #4f46e5; background-color: #e0e7ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-2 text-gray-800"> Control de Gastos</h1>
        <p id="connectionStatus" class="text-center text-xs text-gray-400 mb-6">Conectando a tu nube...</p>
        
        <div class="border-b border-gray-200 mb-8">
            <nav class="flex flex-wrap -mb-px space-x-4" aria-label="Tabs">
                <button class="tab-button active" data-tab="transactions">Transacciones</button>
                <button class="tab-button" data-tab="monthly">Resumen Mensual</button>
                <button class="tab-button" data-tab="chart">Gr谩fico de Gastos</button>
            </nav>
        </div>

        <div id="tab-transactions" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="summary-card income"><p>Total Ingresos</p><p id="totalIncome" class="text-2xl mt-2">$ 0</p></div>
                <div class="summary-card expense"><p>Total Gastos</p><p id="totalExpenses" class="text-2xl mt-2">$ 0</p></div>
                <div class="summary-card balance"><p>Saldo Global</p><p id="currentBalance" class="text-2xl mt-2">$ 0</p></div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">A帽adir Nueva Transacci贸n</h2>
                <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="input-group"><label for="date">Fecha:</label><input type="date" id="date" class="rounded-lg shadow-sm"></div>
                    <div class="input-group"><label for="description">Concepto/Descripci贸n:</label><input type="text" id="description" placeholder="Ej: Salario, Supermercado" class="rounded-lg shadow-sm"></div>
                    <div class="input-group"><label for="category">Categor铆a:</label><select id="category" class="rounded-lg shadow-sm"><option value="">Selecciona</option><option value="Ingresos">Ingresos</option><option value="Alimentaci贸n">Alimentaci贸n</option><option value="Transporte">Transporte</option><option value="Vivienda">Vivienda</option><option value="Servicios">Servicios</option><option value="Entretenimiento">Entretenimiento</option><option value="Salud">Salud</option><option value="Educaci贸n">Educaci贸n</option><option value="Ropa">Ropa</option><option value="Otros">Otros</option></select></div>
                    <div class="input-group"><label for="type">Tipo:</label><select id="type" class="rounded-lg shadow-sm"><option value="">Selecciona</option><option value="Ingreso">Ingreso</option><option value="Gasto">Gasto</option></select></div>
                    <div class="input-group"><label for="amount">Valor:</label><input type="number" id="amount" placeholder="Ej: 50000" min="0" step="1" class="rounded-lg shadow-sm"></div>
                    <div class="input-group md:col-span-2 lg:col-span-1 flex items-end"><button type="submit" class="btn btn-primary w-full mt-6">A帽adir</button></div>
                </form>
            </div>
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Historial</h2>
            <div class="overflow-x-auto rounded-lg shadow-md"><table class="min-w-full bg-white"><thead><tr class="table-header"><th class="rounded-tl-lg">Fecha</th><th>Concepto</th><th>Categor铆a</th><th>Tipo</th><th>Valor</th><th>Saldo Acum.</th><th class="rounded-tr-lg text-center"></th></tr></thead><tbody id="transactionsTableBody"></tbody></table><p id="noTransactionsMessage" class="text-center py-4 text-gray-500">A煤n no hay transacciones.</p></div>
        </div>

        <div id="tab-monthly" class="tab-content">
             <h2 class="text-xl font-semibold mb-4 text-gray-700">Balance por Mes</h2>
             <div id="monthlySummaryContainer" class="overflow-x-auto rounded-lg shadow-md"></div>
             <p id="noMonthlyDataMessage" class="text-center py-4 text-gray-500 hidden">No hay datos.</p>
        </div>

        <div id="tab-chart" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Gastos por Categor铆a</h2>
            <div class="bg-white p-4 rounded-lg shadow-md">
                <canvas id="expenseChart" class="mx-auto" style="max-width: 450px; max-height: 450px;"></canvas>
                <p id="noChartDataMessage" class="text-center py-4 text-gray-500 hidden">No hay gastos para mostrar.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // PASO FINAL: PEGA AQU TUS "LLAVES" DE FIREBASE
        // Reemplaza todo este bloque de 'firebaseConfig' con el que copiaste 
        // del Paso 3 de la gu铆a.
        // =================================================================================
      const firebaseConfig = {
  apiKey: "AIzaSyCtx5dczhAdJASGkmPxve2T-4RFee3bVug",
  authDomain: "mis-gastos-personales-57e39.firebaseapp.com",
  projectId: "mis-gastos-personales-57e39",
  storageBucket: "mis-gastos-personales-57e39.firebasestorage.app",
  messagingSenderId: "746432410147",
  appId: "1:746432410147:web:02d95cf9bee186f090f796"
};
        // =================================================================================
        
        const dom = {
            transactionForm: document.getElementById('transactionForm'), dateInput: document.getElementById('date'), descriptionInput: document.getElementById('description'), categorySelect: document.getElementById('category'), typeSelect: document.getElementById('type'), amountInput: document.getElementById('amount'), transactionsTableBody: document.getElementById('transactionsTableBody'), totalIncomeElem: document.getElementById('totalIncome'), totalExpensesElem: document.getElementById('totalExpenses'), currentBalanceElem: document.getElementById('currentBalance'), noTransactionsMessage: document.getElementById('noTransactionsMessage'), connectionStatus: document.getElementById('connectionStatus'), tabButtons: document.querySelectorAll('.tab-button'), tabContents: document.querySelectorAll('.tab-content'), monthlySummaryContainer: document.getElementById('monthlySummaryContainer'), noMonthlyDataMessage: document.getElementById('noMonthlyDataMessage'), expenseChartCanvas: document.getElementById('expenseChart'), noChartDataMessage: document.getElementById('noChartDataMessage'),
        };
        
        let db, auth, userId, transactionsCollectionRef, unsubscribeListener = null, expenseChart = null;

        const formatCOP = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        const setDefaultDate = () => { dom.dateInput.value = new Date().toISOString().slice(0, 10); };
        
        const renderAll = (transactions) => {
            renderTransactionsTable(transactions);
            renderMonthlySummary(transactions);
            renderExpenseChart(transactions);
        };

        const renderTransactionsTable = (transactions) => {
            const sorted = [...transactions].sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
            dom.transactionsTableBody.innerHTML = '';
            dom.noTransactionsMessage.style.display = sorted.length === 0 ? 'block' : 'none';
            let totalIncome = 0, totalExpenses = 0, runningBalance = 0;
            const rowsData = sorted.map(t => {
                if (t.type === 'Ingreso') { totalIncome += t.amount; runningBalance += t.amount; } 
                else { totalExpenses += t.amount; runningBalance -= t.amount; }
                return { ...t, runningBalance };
            });
            rowsData.reverse().forEach(t => {
                const row = document.createElement('tr');
                const balanceClass = t.runningBalance >= 0 ? 'running-balance-positive' : 'running-balance-negative';
                row.innerHTML = `<td>${t.date}</td><td>${t.description}</td><td>${t.category}</td><td>${t.type}</td><td>${formatCOP(t.amount)}</td><td class="${balanceClass}">${formatCOP(t.runningBalance)}</td><td class="text-center"><button class="btn-delete" data-id="${t.id}"><i class="fas fa-trash-alt"></i></button></td>`;
                dom.transactionsTableBody.appendChild(row);
            });
            dom.transactionsTableBody.querySelectorAll('.btn-delete').forEach(button => button.addEventListener('click', e => deleteDoc(doc(transactionsCollectionRef, e.currentTarget.dataset.id))));
            const currentBalance = totalIncome - totalExpenses;
            dom.totalIncomeElem.textContent = formatCOP(totalIncome); dom.totalExpensesElem.textContent = formatCOP(totalExpenses); dom.currentBalanceElem.textContent = formatCOP(currentBalance);
        };

        const renderMonthlySummary = (transactions) => {
            if (transactions.length === 0) { dom.noMonthlyDataMessage.style.display = 'block'; dom.monthlySummaryContainer.innerHTML = ''; return; }
            dom.noMonthlyDataMessage.style.display = 'none';
            const monthlyData = transactions.reduce((acc, t) => {
                const monthYear = new Date(t.date).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', timeZone: 'UTC' });
                if (!acc[monthYear]) acc[monthYear] = { income: 0, expense: 0, date: new Date(t.date.substring(0, 7) + '-01T00:00:00') };
                if (t.type === 'Ingreso') acc[monthYear].income += t.amount; else acc[monthYear].expense += t.amount;
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => monthlyData[b].date - monthlyData[a].date);
            let tableHTML = '<table class="min-w-full bg-white"><thead><tr class="table-header"><th>Mes</th><th>Ingresos</th><th>Gastos</th><th>Saldo</th></tr></thead><tbody>';
            sortedMonths.forEach(month => {
                const data = monthlyData[month];
                const balance = data.income - data.expense;
                tableHTML += `<tr><td>${month.charAt(0).toUpperCase() + month.slice(1)}</td><td>${formatCOP(data.income)}</td><td>${formatCOP(data.expense)}</td><td class="${balance >= 0 ? 'running-balance-positive' : 'running-balance-negative'}">${formatCOP(balance)}</td></tr>`;
            });
            dom.monthlySummaryContainer.innerHTML = tableHTML + '</tbody></table>';
        };

        const renderExpenseChart = (transactions) => {
            const expenseData = transactions.filter(t => t.type === 'Gasto').reduce((acc, t) => { if (!acc[t.category]) acc[t.category] = 0; acc[t.category] += t.amount; return acc; }, {});
            if (Object.keys(expenseData).length === 0) { dom.noChartDataMessage.style.display = 'block'; dom.expenseChartCanvas.style.display = 'none'; if (expenseChart) expenseChart.destroy(); return; }
            dom.noChartDataMessage.style.display = 'none'; dom.expenseChartCanvas.style.display = 'block';
            const labels = Object.keys(expenseData), data = Object.values(expenseData), colors = labels.map((_, i) => `hsl(${(i * 360 / labels.length + 40) % 360}, 70%, 60%)`);
            if (expenseChart) expenseChart.destroy();
            expenseChart = new Chart(dom.expenseChartCanvas, {
                type: 'pie', data: { labels, datasets: [{ data, backgroundColor: colors }] },
                options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCOP(c.parsed)} (${((c.parsed / c.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(2)}%)` } } } }
            });
        };
        
        const addTransaction = async (e) => {
            e.preventDefault();
            if (!userId) return;
            const { dateInput, descriptionInput, categorySelect, typeSelect, amountInput } = dom;
            const date = dateInput.value, description = descriptionInput.value.trim(), category = categorySelect.value, type = typeSelect.value, amount = parseFloat(amountInput.value);
            if (!date || !description || !category || !type || isNaN(amount) || amount <= 0) { alert('Por favor, rellena todos los campos.'); return; }
            try { await addDoc(transactionsCollectionRef, { date, description, category, type, amount, createdAt: serverTimestamp() }); dom.transactionForm.reset(); setDefaultDate(); } catch (error) { console.error("Error al a帽adir:", error); }
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    dom.connectionStatus.textContent = `Conectado como: ${userId.substring(0, 8)}...`;
                    dom.connectionStatus.className = "text-center text-xs text-green-600 mb-6";
                    transactionsCollectionRef = collection(db, "users", userId, "transactions");
                    unsubscribeListener = onSnapshot(query(transactionsCollectionRef, orderBy("createdAt", "desc")), snapshot => renderAll(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                } else {
                    signInAnonymously(auth).catch(error => console.error("Error de inicio de sesi贸n an贸nimo:", error));
                }
            });
            dom.transactionForm.addEventListener('submit', addTransaction);
            dom.tabButtons.forEach(btn => btn.addEventListener('click', e => {
                dom.tabButtons.forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                dom.tabContents.forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${e.currentTarget.dataset.tab}`).classList.add('active');
            }));
            setDefaultDate();
        } catch (error) {
            console.error("Error de inicializaci贸n de Firebase:", error);
            dom.connectionStatus.textContent = "Error de conexi贸n. Verifica tus llaves de Firebase.";
            dom.connectionStatus.className = "text-center text-xs text-red-600 mb-6";
        }
    </script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>
</body>
</html>

