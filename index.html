<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Inter", sans-serif; background-color: #f3f4f6; }
        .container { max-width: 90%; margin: 2rem auto; padding: 1.5rem; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; border: none; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-delete { background: none; border: none; color: #ef4444; cursor: pointer; }
        .summary-card { padding: 1.25rem; border-radius: 0.5rem; text-align: center; font-weight: 600; }
        .summary-card.income { background-color: #d1fae5; color: #065f46; }
        .summary-card.expense { background-color: #fee2e2; color: #991b1b; }
        .summary-card.balance { background-color: #e0f2fe; color: #1e40af; }
        .running-balance-positive { color: #10b981; }
        .running-balance-negative { color: #dc2626; }
        .tab-button { background-color: transparent; border: 2px solid transparent; color: #6b7280; padding: 0.5rem 1rem; font-weight: 600; border-radius: 0.5rem; }
        .tab-button.active { color: #4f46e5; border-color: #4f46e5; background-color: #e0e7ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 1rem; overflow: hidden; }
        .progress-bar-fill { height: 100%; transition: width 0.5s ease-in-out; border-radius: 9999px; }
        .bg-progress-green { background-color: #34d399; }
        .bg-progress-yellow { background-color: #f59e0b; }
        .bg-progress-red { background-color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">📊 Control de Gastos</h1>
        <p id="connectionStatus" class="text-center text-xs text-gray-400 mb-6">Conectando a tu nube...</p>
        
        <div id="notifications" class="fixed top-5 right-5 z-50 space-y-2"></div>

        <div class="border-b border-gray-200 mb-8">
            <nav class="flex flex-wrap -mb-px space-x-2 sm:space-x-4" aria-label="Tabs">
                <button class="tab-button active" data-tab="transactions">Transacciones</button>
                <button class="tab-button" data-tab="budgets">Presupuestos</button>
                <button class="tab-button" data-tab="goals">Metas de Ahorro</button>
                <button class="tab-button" data-tab="recurring">Gastos Fijos</button>
                <button class="tab-button" data-tab="monthly">Resumen Mensual</button>
                <button class="tab-button" data-tab="chart">Gráfico de Gastos</button>
                <button class="tab-button" data-tab="tools">Herramientas</button>
            </nav>
        </div>

        <div id="tab-transactions" class="tab-content active"></div>
        <div id="tab-budgets" class="tab-content"></div>
        <div id="tab-goals" class="tab-content"></div>
        <div id="tab-recurring" class="tab-content"></div>
        <div id="tab-monthly" class="tab-content"></div>
        <div id="tab-chart" class="tab-content"></div>
        
        <div id="tab-tools" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Herramientas de Datos</h2>
            <p class="text-sm text-gray-500 mb-6">Realiza copias de seguridad de tus datos o restáuralos desde un archivo.</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1 bg-blue-100 p-6 rounded-lg shadow-inner text-center">
                    <h3 class="font-semibold text-blue-800 mb-2 text-lg">Exportar Datos</h3>
                    <p class="text-sm text-blue-700 mb-4">Guarda todas tus transacciones, presupuestos, metas y gastos fijos en un archivo JSON.</p>
                    <button id="exportBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full"><i class="fas fa-download mr-2"></i>Exportar mi Información</button>
                </div>
                <div class="flex-1 bg-green-100 p-6 rounded-lg shadow-inner text-center">
                    <h3 class="font-semibold text-green-800 mb-2 text-lg">Importar Datos</h3>
                    <p class="text-sm text-green-700 mb-4">Carga tus datos desde un archivo de respaldo. Esto reemplazará todos los datos actuales.</p>
                    <button id="importBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-full"><i class="fas fa-upload mr-2"></i>Importar desde Archivo</button>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, query, orderBy, serverTimestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // PASO FINAL: PEGA AQUÍ TUS "LLAVES" DE FIREBASE
        // =================================================================================
         const firebaseConfig = {
            apiKey: "AIzaSyCtx5dczhAdJASGkmPxve2T-4RFee3bVug",
            authDomain: "mis-gastos-personales-57e39.firebaseapp.com",
            projectId: "mis-gastos-personales-57e39",
            storageBucket: "mis-gastos-personales-57e39.firebasestorage.app",
            messagingSenderId: "746432410147",
            appId: "1:746432410147:web:02d95cf9bee186f090f796"
        };
        // =================================================================================
        
        // --- INJECT TEMPLATES ---
        document.getElementById('tab-transactions').innerHTML = `...`; // Omitted for brevity, same as before
        document.getElementById('tab-budgets').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Presupuestos del Mes Actual</h2><p class="text-sm text-gray-500 mb-6">Define un límite de gasto para cada categoría.</p><div id="budgetsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>`;
        document.getElementById('tab-goals').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Metas de Ahorro</h2><div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8"><form id="goalForm" class="flex flex-col sm:flex-row gap-4 items-end"><div class="input-group flex-1"><label for="goalName">Nombre de la Meta:</label><input type="text" id="goalName" placeholder="Ej: Vacaciones" class="rounded-lg"></div><div class="input-group flex-1"><label for="goalAmount">Monto Objetivo:</label><input type="number" id="goalAmount" placeholder="Ej: 2000000" min="0" step="1" class="rounded-lg"></div><button type="submit" class="btn btn-primary w-full sm:w-auto">Crear Meta</button></form></div><div class="summary-card balance mb-8"><p>Ahorro Total Disponible</p><p id="totalSavings" class="text-2xl mt-2">$ 0</p></div><div id="goalsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>`;
        document.getElementById('tab-recurring').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Gastos Fijos Mensuales</h2><div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8"><form id="recurringForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end"><div class="input-group"><label for="recurringDescription">Descripción:</label><input type="text" id="recurringDescription" placeholder="Ej: Arriendo" class="rounded-lg"></div><div class="input-group"><label for="recurringCategory">Categoría:</label><select id="recurringCategory" class="rounded-lg"><option value="">Selecciona</option><option value="Vivienda">Vivienda</option><option value="Servicios">Servicios</option><option value="Transporte">Transporte</option><option value="Educación">Educación</option><option value="Entretenimiento">Entretenimiento</option><option value="Salud">Salud</option><option value="Otros">Otros</option></select></div><div class="input-group"><label for="recurringAmount">Monto:</label><input type="number" id="recurringAmount" placeholder="Ej: 1000000" min="0" step="1" class="rounded-lg"></div><button type="submit" class="btn btn-primary w-full mt-4 md:mt-0">Añadir Gasto Fijo</button></form></div><div class="mb-8"><button id="addRecurringBtn" class="btn bg-green-600 hover:bg-green-700 text-white w-full"><i class="fas fa-plus-circle mr-2"></i>Añadir Gastos Fijos de este Mes a Transacciones</button></div><div id="recurringContainer" class="overflow-x-auto rounded-lg shadow-md"></div>`;
        document.getElementById('tab-monthly').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Balance por Mes</h2><div id="monthlySummaryContainer" class="overflow-x-auto rounded-lg shadow-md"></div><p id="noMonthlyDataMessage" class="text-center py-4 text-gray-500 hidden">No hay datos.</p>`;
        document.getElementById('tab-chart').innerHTML = `<h2 class="text-xl font-semibold mb-4 text-gray-700">Gastos por Categoría</h2><div class="bg-white p-4 rounded-lg shadow-md"><canvas id="expenseChart" class="mx-auto" style="max-width: 450px; max-height: 450px;"></canvas><p id="noChartDataMessage" class="text-center py-4 text-gray-500 hidden">No hay gastos para mostrar.</p></div>`;

        const dom = { /* ... Re-grab all DOM elements including new import/export buttons ... */ };
        
        let db, auth, userId, transactions = [], budgets = {}, goals = [], recurring = [], expenseChart = null;
        let listeners = {};

        const formatCOP = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        const setDefaultDate = () => { if(dom.dateInput) dom.dateInput.value = new Date().toISOString().slice(0, 10); };
        const showNotification = (message, type = 'info') => { /* ... existing code ... */ };
        
        // --- RENDER FUNCTIONS ---
        const renderAll = () => { /* ... existing code ... */ };
        const renderTransactionsTable = () => { /* ... existing code ... */ };
        const renderMonthlySummary = () => { /* ... existing code ... */ };
        const renderExpenseChart = () => { /* ... existing code ... */ };
        const renderBudgets = () => { /* ... existing code ... */ };
        const renderGoals = () => { /* ... existing code ... */ };
        const renderRecurring = () => { /* ... existing code ... */ };
        
        // --- CRUD & CORE LOGIC ---
        const addTransaction = async (e) => { /* ... existing code ... */ };
        const saveBudget = async (category, amount) => { await setDoc(doc(db, "users", userId, "budgets", category), { amount }); };
        const saveGoal = async (e) => { /* ... existing code ... */ };
        const saveRecurring = async (e) => { /* ... existing code ... */ };
        const postRecurringTransactions = async () => { /* ... existing code ... */ };

        // --- IMPORT/EXPORT LOGIC ---
        const exportData = async () => {
            if (!userId) { showNotification('No se puede exportar. No hay usuario conectado.', 'error'); return; }
            try {
                const backupData = {
                    transactions: transactions.map(({id, ...t}) => t), // Remove local id
                    budgets,
                    goals: goals.map(({id, ...g}) => g),
                    recurring: recurring.map(({id, ...r}) => r)
                };
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const date = new Date().toISOString().slice(0, 10);
                link.download = `respaldo-gastos-${date}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Datos exportados con éxito.', 'success');
            } catch (error) {
                console.error("Error al exportar:", error);
                showNotification('Ocurrió un error al exportar los datos.', 'error');
            }
        };

        const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.transactions || !importedData.budgets || !importedData.goals || !importedData.recurring) {
                        throw new Error("El archivo no tiene el formato correcto.");
                    }
                    if (!confirm('¿Estás seguro? Esto reemplazará TODOS tus datos actuales. Esta acción es irreversible.')) return;
                    
                    const batch = writeBatch(db);
                    
                    // Delete existing data
                    const collections = ["transactions", "budgets", "goals", "recurringExpenses"];
                    for (const coll of collections) {
                        const snapshot = await getDocs(collection(db, "users", userId, coll));
                        snapshot.forEach(doc => batch.delete(doc.ref));
                    }
                    
                    // Add new data
                    importedData.transactions.forEach(t => batch.set(doc(collection(db, "users", userId, "transactions")), t));
                    Object.keys(importedData.budgets).forEach(key => batch.set(doc(db, "users", userId, "budgets", key), { amount: importedData.budgets[key] }));
                    importedData.goals.forEach(g => batch.set(doc(collection(db, "users", userId, "goals")), g));
                    importedData.recurring.forEach(r => batch.set(doc(collection(db, "users", userId, "recurringExpenses")), r));

                    await batch.commit();
                    showNotification('Datos importados y reemplazados con éxito.', 'success');

                } catch (error) {
                    console.error("Error al importar:", error);
                    showNotification('Error al importar el archivo. Revisa que sea válido.', 'error');
                } finally {
                    dom.importFile.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        };
        
        const setupFirestoreListeners = () => { /* ... existing code ... */ };
        
        const main = async () => {
            // Setup all event listeners, including new import/export buttons
            dom.exportBtn.addEventListener('click', exportData);
            dom.importBtn.addEventListener('click', () => dom.importFile.click());
            dom.importFile.addEventListener('change', importData);
            // ... other listeners
        };

        main();
    </script>
</body>
</html>
